#!/usr/bin/python
#coding=utf-8

import poplib
#coding:utf-8
import cStringIO
import email
import email.Header
import base64,os,sys,re
import time
import datetime


yesterday=time.strftime("%Y/%m/%d",time.localtime(time.time()-24*60*60))
yesterday1=time.strftime("%Y%m%d",time.localtime(time.time()-24*60*60))
#sub="Fwd: %s - D10 - Daily Details Report & Statement" % (yesterday)
#sub="%s *- *D10 *- *Daily *Details *Report *& *Statement" % (yesterday)
sub="??"   #????
print sub
wd = '/tmp'
f1 = wd+"/"+yesterday1+"_D10_UK_Details.xls"
os.chdir(wd)     # ??????,????????????

if os.path.isfile(f1):                 #????????????,?:????;?:???
        print "file is existed..."
        sys.exit()

#POP3??
M = poplib.POP3('pop3.163.com')   #???????
M.user('18829210056')    #????
M.pass_('wyh123')   #??
#???????
num = len(M.list()[1])
print 'num of messages', num
if num >= 5:
        num1 = num-5
else:
        num1 = 0

#for i in range(numMessages):
for i in range(num,num1,-1):
    #m = M.retr(i+1)
    m = M.retr(i)

    buf = cStringIO.StringIO()
    for j in m[1]:
        print >>buf, j
    buf.seek(0)
    #??????
    msg = email.message_from_file(buf)
    subject = msg.get("subject") # ??????subject, ?????
    # ??????????????=?gbk?Q?=CF=E0=C6=AC?=???subject
    h = email.Header.Header(subject)
    dh = email.Header.decode_header(h)
    subcode = dh[0][1]
    subject = dh[0][0]
    if not subcode :
        subcode = 'utf-8'
    print "subcode",subcode
    print "subject:", unicode(subject,subcode)
    #if subject == sub:
    if re.search(sub,subject):              # ????????? sub ????
        # ?????????mime????
        for par in msg.walk():
            if not par.is_multipart(): # ????????multipart,???,?????????,??????>???mime?????
                name = par.get_param("name") #?????,????????????
                if name:
                #???
                # ??????????????=?gbk?Q?=CF=E0=C6=AC.rar?=??????
                    h = email.Header.Header(name)
                    dh = email.Header.decode_header(h)
                    fname = dh[0][0]
                    fcode = dh[0][1]
                    if not fcode:
                        fcode = 'utf-8'
                    fname = unicode(fname,fcode)
                    print '???:',fname+' fcode:',fcode
                    data = par.get_payload(decode=True) # ???????,????????

                    try:
                        f = open(fname, 'wb') #??????wb?????,?????????????
                    except:
                        print '????????,?????'
                        f = open('aaaa', 'wb')
                    f.write(data)
                    f.close()
                else:
                #????,?????
                    body = par.get_payload(decode=True) # ???????,??????????
                    print 'body:'
                    #print 'body:',body       #???????,????????
                print '+'*60 # ???????????
    else:
        continue
    print '\n'
M.quit()
print 'exit'

